---
title: "update_formulas"
output: html_document
date: "2025-01-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(googledrive)
library(googlesheets4)
library(DT)
library(purrr)
library(lubridate)
library(gargle)

gs4_deauth()
gs4_auth(token = gargle::secret_read_rds(
  ".secrets/gs4-token.rds",
  key = "GOOGLE_DRIVE_KEY"
))
#gs4_auth(cache = ".secrets", email = "schroejh@bc.edu", scope = "https://www.googleapis.com/auth/drive")
drive_auth(token = gs4_token())

folder_ids <- c("1vsjVWIWOAH1xN8RPvhgmI6ky1vA7CfcJ",
                "145ECofup4M7ZnA1dUF5_pDZN3OWEK1Yb",
                "1gi-k4cgD-XR_AiaSq6J9OPf3OWwkIPCt",
                "1IYkTrGI07fTcjaggY_12V72syNATNSIp",
                "10-NQy1b9lXuXnm5X_FuzYpetI_1PgjOQ",
                "1FbOjmMtKKbgpDou-eyVbhb162RQJMNy-",
                "1LEYANh7PIV9BIC4GpmWByWR4mi2dNtih")

files <- lapply(folder_ids, function(folder) {
  drive_ls(as_id(folder))
})
files <- do.call("rbind", files) 
files <- files %>% filter(!(str_detect(name, "TEMPLATE")))

```

# Add year and diocese to all sheets 

```{r}
for(i in 1:nrow(files)){
        year <- as.numeric(str_extract(files$name[i], "\\d+"))
        place <- str_extract(files$name[i], "[A-Za-z]+")
 # WRITE YEARS
        range_write(files$id[i], 
                   data.frame(year),
                   sheet = "master",
                   range = "AC2",
                   col_names = FALSE,
                   reformat = FALSE)
        range_write(files$id[i], 
                    data.frame("year"),
                    sheet = "master",
                    range = "AC1",
                    col_names = FALSE,
                    reformat = FALSE)
 # WRITE DIOCESE
        range_write(files$id[i], 
                    data.frame(place),
                    sheet = "master",
                    range = "AD2",
                    col_names = FALSE,
                    reformat = FALSE)
        range_write(files$id[i], 
                    data.frame("diocese"),
                    sheet = "master",
                    range = "AD1",
                    col_names = FALSE,
                    reformat = FALSE)
      }
```

# Add new formulas 

```{r}
for(i in 1:nrow(files)){
  nrows <- as.numeric(nrow(range_read(files$id[i])))
  
  formulas <- paste0('=ARRAYFORMULA(XLOOKUP(peopleInfo!K', 2:nrows , ' & master!AD$2 & master!AC$2,
  IMPORTRANGE("10rvRUGe4br313NCdOI7saxbwb9xmuY5OyOZkFojPk2k", "personIDs!A:A") & 
  IMPORTRANGE("10rvRUGe4br313NCdOI7saxbwb9xmuY5OyOZkFojPk2k", "personIDs!B:B") & 
  IMPORTRANGE("10rvRUGe4br313NCdOI7saxbwb9xmuY5OyOZkFojPk2k", "personIDs!C:C"),
  IMPORTRANGE("10rvRUGe4br313NCdOI7saxbwb9xmuY5OyOZkFojPk2k", "personIDs!E:E"), ""))')
  
  formula <- as.data.frame(list(formula = formulas)) 
  formula$formula <- gs4_formula(formula$formula)
  
  #range_delete(files$id[i], 
  #             sheet = "peopleInfo", 
  #             cell_cols("M:O"), 
  #             shift = NULL)

  range_write(files$id[i], 
              data = formula,
              sheet = "peopleInfo",
              range = paste0("L2:L", nrows),
              col_names = FALSE,
              reformat = FALSE)
}

```

```{r}
for(i in 1:nrow(files)){
  
 # peopleInfo <- range_read(files$id[i], 
#               sheet = "peopleInfo", 
#               range = "A1")

  peopleIDs <- range_read(files$id[i], 
               sheet = "peopleInfo", 
               range = "B2")
  
 # print(colnames(peopleInfo))
  print(colnames(peopleIDs))  
}
```


```{r}

for(i in 139:nrow(files)){
  
  nrows <- as.numeric(nrow(range_read(files$id[i])))
  
    formulas <- paste0('=ARRAYFORMULA(XLOOKUP(peopleInfo!K', 2:nrows , ' & master!AD$2 & master!AC$2,
  IMPORTRANGE("10rvRUGe4br313NCdOI7saxbwb9xmuY5OyOZkFojPk2k", "personIDs!A:A") & 
  IMPORTRANGE("10rvRUGe4br313NCdOI7saxbwb9xmuY5OyOZkFojPk2k", "personIDs!B:B") & 
  IMPORTRANGE("10rvRUGe4br313NCdOI7saxbwb9xmuY5OyOZkFojPk2k", "personIDs!C:C"),
  IMPORTRANGE("10rvRUGe4br313NCdOI7saxbwb9xmuY5OyOZkFojPk2k", "personIDs!E:E"), ""))')
  
  formula <- as.data.frame(list(formula = formulas)) 
  formula$formula <- gs4_formula(formula$formula)

  # peopleInfo
  # Delete peopleInfo!A
  
  range_delete(files$id[i], 
            sheet = "peopleInfo", 
            range = "A:A")
  
F2 <- data.frame(form = '=ARRAYFORMULA(LOWER(REGEXREPLACE(REGEXREPLACE(B2:B, "[[:punct:]-â€”]", ""), "\b(Von|De|La|Der|Van|von|de|la|der|van)\\s+(\\w+)", "$1-$2")))')
G2 <- data.frame(form = '=ARRAYFORMULA(IFERROR(REGEXEXTRACT(F2:F, "\\s(\\S+)$"), F2:F))')
H2 <- data.frame(form = '=ARRAYFORMULA(IF(LEN(F2:F) - LEN(SUBSTITUTE(F2:F, " ", "")) = 0, , IFERROR(REGEXEXTRACT(F2:F, "^(.*)\\s\\S+$"), F2:F)))')
I2 <- data.frame(form = '=ARRAYFORMULA(IFERROR(REGEXEXTRACT(H2:H, "^\\S+"), H2:H))')
J2 <- data.frame(form = '=ARRAYFORMULA(IFERROR(REGEXEXTRACT(H2:H, "^\\S+\\s(.*)"), ""))')
K2 <- data.frame(form = '=ARRAYFORMULA(
  SUBSTITUTE(
    IF( 
      REGEXMATCH(A2:A, "(Sister|Mother|OtherException|Brother|Bro.)") +
      REGEXMATCH(B2:B, "(Brother|Sister|Ladies)") +
      (ISBLANK(I2:I) * ISBLANK(G2:G)),
      "",
      IF(
        ISBLANK(I2:I),
        G2:G,
        IF(
          LEN(I2:I) >= 3,
          IF(
            ISBLANK(J2:J),
            LEFT(I2:I, 3) & "_" & G2:G,
            LEFT(I2:I, 3) & "_" & LEFT(J2:J, 1) & "_" & G2:G
          ),
          IF(
            LEN(I2:I) = 2,
            IF(
              ISBLANK(J2:J),
              LEFT(I2:I, 2) & "_" & G2:G,
              LEFT(I2:I, 2) & "_" & LEFT(J2:J, 1) & "_" & G2:G
            ),
            IF(
              LEN(I2:I) = 1,
              IF(
                ISBLANK(J2:J),
                LEFT(I2:I, 1) & "_" & G2:G,
                LEFT(I2:I, 1) & "_" & LEFT(J2:J, 1) & "_" & G2:G
              ),
              ""
            )
          )
        )
      )
    ),
    "__", "_"
  )
)')

F2$form <- gs4_formula(F2$form) 
G2$form <- gs4_formula(G2$form) 
H2$form <- gs4_formula(H2$form) 
I2$form <- gs4_formula(I2$form) 
J2$form <- gs4_formula(J2$form) 
K2$form <- gs4_formula(K2$form) 

  range_write(files$id[i], 
            F2,
            sheet = "peopleInfo",
            range = "F2",
            col_names = FALSE,
            reformat = FALSE)
  
  range_write(files$id[i], 
            G2,
            sheet = "peopleInfo",
            range = "G2",
            col_names = FALSE,
            reformat = FALSE)
  
    range_write(files$id[i], 
            H2,
            sheet = "peopleInfo",
            range = "H2",
            col_names = FALSE,
            reformat = FALSE)
    
    range_write(files$id[i], 
            I2,
            sheet = "peopleInfo",
            range = "I2",
            col_names = FALSE,
            reformat = FALSE)
  
    range_write(files$id[i], 
            J2,
            sheet = "peopleInfo",
            range = "J2",
            col_names = FALSE,
            reformat = FALSE)
    
    range_write(files$id[i], 
            K2,
            sheet = "peopleInfo",
            range = "K2",
            col_names = FALSE,
            reformat = FALSE)
  
    range_write(files$id[i], 
              data = formula,
              sheet = "peopleInfo",
              range = paste0("L2:L", nrows),
              col_names = FALSE,
              reformat = FALSE)
  
  # need to also update the other formulas
  
  # peopleIDs
  # A = (persName) =peopleInfo!C:C
  # B = (persID_gen) =peopleInfo!M:M
  # C = (persID_cor)
  # D = (persID) =IF(C2="",B2,C2)
  
  col1 <- c("persName", "persID_gen", "persID_cor", "persID")
  #col2 <- c("=peopleInfo!C:C", "=peopleInfo!M:M", "", 'IF(C2="",B2,C2)')
  
  df <- as.data.frame(list(col1 = col1)) 
  df <- t(df)
  
   range_write(files$id[i], 
               data.frame(df),
               sheet = "peopleIDs",
               range = "A1:D1",
               col_names = FALSE,
               reformat = FALSE)
   
  A2 <- data.frame(form = rep('=peopleInfo!B:B', (nrows-1)))
  B2 <- data.frame(form = rep('=peopleInfo!L:L', (nrows-1)))
  D2 <- data.frame(form = paste0('=IF(C', 2:nrows, '="",B', 2:nrows, ',C', 2:nrows, ')')) 
   
  A2$form <- gs4_formula(A2$form) 
  B2$form <- gs4_formula(B2$form) 
  D2$form <- gs4_formula(D2$form) 

  range_write(files$id[i], 
            A2,
            sheet = "peopleIDs",
            range = paste0("A2:A", nrows),
            col_names = FALSE,
            reformat = FALSE)
  
  range_write(files$id[i], 
            B2,
            sheet = "peopleIDs",
            range = paste0("B2:B", nrows),
            col_names = FALSE,
            reformat = FALSE)
  
  range_clear(files$id[i], 
              sheet = "peopleIDs", 
              range = paste0("C2:C", nrows), 
              reformat = TRUE)
  
    
    range_write(files$id[i], 
            D2,
            sheet = "peopleIDs",
            range = "D2",
            col_names = FALSE,
            reformat = FALSE)
  
  # master
  # T = (persID) =peopleIDs!T:T

    T2 <- data.frame(form = rep('=peopleIDs!D:D', (nrows-1)))
    T2$form <- gs4_formula(T2$form) 

  range_write(files$id[i], 
              T2,
              sheet = "master",
              range = paste0("T2:T", nrows),
              col_names = FALSE,
              reformat = FALSE)
}

```

```{r}
for(i in 139:nrow(files)){
 # peopleInfo <- range_read(files$id[i], 
#               sheet = "peopleInfo", 
#               range = "A1")
  
 #   tryCatch(
#    {

    #    range_write(files$id[i], 
    #               data.frame("initialID"),
    #               sheet = "peopleInfo",
    #               range = "K1",
    #               col_names = FALSE,
    #               reformat = FALSE)
    #    range_write(files$id[i], 
    #                data.frame("persID_gen"),
    #                sheet = "peopleInfo",
    #                range = "L1",
    #                col_names = FALSE,
    #                reformat = FALSE)

  peopleIDs <- range_read(files$id[i], 
               sheet = "peopleInfo", 
               range = "K:K") %>% 
    mutate(wrong = str_detect(initialID, "\b(\\w{3})_\1\b")) %>%
    filter(wrong == TRUE)
  
  #print(colnames(peopleInfo))
  if (nrow(peopleIDs != 0)) {
  print(peopleIDs) }
  else next
    }#,
  #    error = function(e) {
  #      message("This sheet needs column names!")
  #    })
  
#}

```

